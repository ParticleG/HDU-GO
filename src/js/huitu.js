/**
 * 杭电图书馆
 * 在 https://hdu.huitu.zhishulib.com/404 中注入本脚本
 */

'use strict';

// 入口
window.onload = async () => {
	initPage();

  const { DATA: userInfo } = await fetUserInfo();

  renderUser(userInfo);
  renderStudyRoomForm();
  renderLog();

  document.querySelector('button').onclick = async () => {
    const [beginTime, duration, floor, seatNo] = Array.from(document.querySelectorAll('input, select')).map(item => item.value);
    const obj = {};
    obj.beginTime = (new Date(beginTime)).valueOf().toString().substr(0, 10);
    obj.duration = duration * 60 * 60;
    obj['seats[0]'] = getSeatId(floor, seatNo);
    obj['seatBookers[0]'] = userInfo.uid;
    const data = Object.keys(obj).map(key => `${key}=${obj[key]}`).join('&');
    const { DATA: res } = await post('https://hdu.huitu.zhishulib.com/Seat/Index/bookSeats?LAB_JSON=1', data);
    if (res.result === 'success') {
      alert('success');
    }
  }
};

async function get(url) {
  const response = await fetch(url);
  const res = await response.json();
  if (res.CODE === 'redirect') {
    location.href = `../#!${res.DATA.href}`;
  }
  return res;
}

async function post(url, postData) {
  const response = await fetch(url, {
    method: 'POST',
    body: postData,
    headers: {
      'content-type': 'application/x-www-form-urlencoded',
    }
  });
  const res = await response.json();
  if (res.MESSAGE) {
    addElement('h4', `${(new Date()).toTimeString().substr(0, 8)}: ${res.MESSAGE}`);
  } else if (res.DATA.msg) {
    addElement('h4', `${(new Date()).toTimeString().substr(0, 8)}: ${res.DATA.msg}`);
  }
  return res;
}

function fetUserInfo() {
  return get('https://hdu.huitu.zhishulib.com/Station/Station/getUnreadMessageCount?LAB_JSON=1');
}

function initPage() {
  // 添加响应式头
  addElement('meta', '', {
    name: 'viewport',
    content: 'width=device-width, initial-scale=1.0',
  }, document.head);
  // 清空body内容
  document.body.innerHTML = '';
  // 标题
  addElement('h1', 'HDU Lib Seats Hunter');
}

function renderUser(userInfo) {
  addElement('hr');
  addElement('h2', 'userInfo');
  addElement('h4', `uid: ${userInfo.uid}`);
  addElement('h4', `uname: ${userInfo.uname}`);
  addElement('h4', `unickname: ${userInfo.unickname}`);
}

function renderStudyRoomForm() {
  addElement('hr');
  addElement('h2', 'Book Seat');
  addElement('h4', `beginTime:
    <input
      type="datetime-local"
      value="${(new Date()).toISOString().substr(0, 10)}T08:00"
    />`);
  addElement('h4', `duration:
    <input type="number" value="14" /> hour(s)
  `);
  addElement('h4', `seatNo:
    <select value="2">
      <option value="2">2楼</option>
      <option value="4">4楼</option>
    </select>
    <input type="number" value="1" />
  `);
  addElement('button', 'BOOK', { style: 'width: 200px; height: 50px; font-size: 24px;' });
}

function renderLog() {
  addElement('hr');
  addElement('h2', 'Log');
}

function getSeatId(floor, seatNo) {
  const SeatData = {
    2: {
      1: 10001,
      2: 10002,
      3: 10003,
      4: 10004,
      5: 10005,
      6: 10006,
      7: 10007,
      8: 10008,
      9: 10009,
      10: 10010,
      11: 10011,
      12: 10012,
      13: 10013,
      14: 10014,
      15: 10015,
      16: 10016,
      17: 10017,
      18: 10018,
      19: 10019,
      20: 10020,
      21: 10021,
      22: 10022,
      23: 10023,
      24: 10024,
      25: 10025,
      26: 10026,
      27: 10027,
      28: 10028,
      29: 10029,
      30: 10030,
      31: 10031,
      32: 10032,
      33: 10033,
      34: 10034,
      35: 10035,
      36: 10036,
      37: 10037,
      38: 10038,
      39: 10039,
      40: 10040,
      41: 10041,
      42: 10042,
      43: 10043,
      44: 10044,
      45: 10045,
      46: 10046,
      47: 10047,
      48: 10048,
      49: 10049,
      50: 10050,
      51: 10051,
      52: 10052,
      53: 10053,
      54: 10054,
      55: 10055,
      56: 10056,
      57: 10057,
      58: 10058,
      59: 10059,
      60: 10060,
      61: 10061,
      62: 10062,
      63: 10063,
      64: 10064,
      65: 10065,
      66: 10066,
      67: 10067,
      68: 10068,
      69: 10069,
      70: 10070,
      71: 10071,
      72: 10072,
      73: 10073,
      74: 10074,
      75: 10075,
      76: 10076,
      77: 10077,
      78: 10078,
      79: 10079,
      80: 10080,
      81: 10081,
      82: 10082,
      83: 10083,
      84: 10084,
      85: 10085,
      86: 10086,
      87: 10087,
      88: 10088,
      89: 10089,
      90: 10090,
      91: 10091,
      92: 10092,
      93: 10093,
      94: 10094,
      95: 10095,
      96: 10096,
      97: 10097,
      98: 10098,
      99: 10099,
      100: 10100,
      101: 10101,
      102: 10102,
      103: 10103,
      104: 10104,
      105: 10105,
      106: 10106,
      107: 10107,
      108: 10108,
      109: 10109,
      110: 10110,
      111: 10111,
      112: 10112,
      113: 10113,
      114: 10114,
      115: 10115,
      116: 10116,
      117: 10117,
      118: 10118,
      119: 10119,
      120: 10120,
      121: 10121,
      122: 10122,
      123: 10123,
      124: 10124,
      125: 10125,
      126: 10126,
      127: 10127,
      128: 10128,
      129: 10129,
      130: 10130,
      131: 10131,
      132: 10132,
      133: 10133,
      134: 10134,
      135: 10135,
      136: 10136,
      137: 10137,
      138: 10138,
      139: 10139,
      140: 10140,
      141: 10141,
      142: 10142,
      143: 10143,
      144: 10144,
      145: 10145,
      146: 10146,
      147: 10147,
      148: 10148,
      149: 10149,
      150: 10150,
      151: 10151,
      152: 10152,
      153: 10153,
      154: 10154,
      155: 10155,
      156: 10156,
      157: 10157,
      158: 10158,
      159: 10159,
      160: 10160,
      161: 10161,
      162: 10162,
      163: 10163,
      164: 10164,
      165: 10165,
      166: 10166,
      167: 10167,
      168: 10168,
      169: 10169,
      170: 10170,
      171: 10171,
      172: 10172,
      173: 10173,
      174: 10174,
      175: 10175,
      176: 10176,
      177: 10177,
      178: 10178,
      179: 10179,
      180: 10180,
      181: 10181,
      182: 10182,
      183: 10183,
      184: 10184,
      185: 10185,
      186: 10186,
      187: 10187,
      188: 10188,
      189: 10189,
      190: 10190,
      191: 10191,
      192: 10192,
      193: 10193,
      194: 10194,
      195: 10195,
      196: 10196,
      197: 10197,
      198: 10198,
      199: 10199,
      200: 10200,
      201: 10201,
      202: 10202,
      203: 10203,
      204: 10204,
      205: 10205,
      206: 10206,
      207: 10207,
      208: 10208,
      209: 10209,
      210: 10210,
      211: 10211,
      212: 10212,
      213: 10213,
      214: 10214,
      215: 10215,
      216: 10216,
      217: 10217,
      218: 10218,
      219: 10219,
      220: 10220,
      221: 10221,
      222: 10222,
      223: 10223,
      224: 10224,
      225: 10225,
      226: 10226,
      227: 10227,
      228: 10228,
      229: 10229,
      230: 10230,
      231: 10231,
      232: 10232,
      233: 10233,
      234: 10234,
      235: 10235,
      236: 10236,
      237: 10237,
      238: 10238,
      239: 10239,
      240: 10240,
      241: 10241,
      242: 10242,
      243: 10243,
      244: 10244,
      245: 10245,
      246: 10246,
      247: 10247,
      248: 10248,
      249: 10249,
      250: 10250,
      251: 10251,
      252: 10252,
      253: 10253,
      254: 10254,
      255: 10255,
      256: 10256,
      257: 10257,
      258: 10258,
      259: 10259,
      260: 10260,
      261: 10261,
      262: 10262,
      263: 10263,
      264: 10264,
      265: 10265,
      266: 10266,
      267: 10267,
      268: 10268,
      269: 10269,
      270: 10270,
      271: 10271,
      272: 10272,
      273: 10273,
      274: 10274,
      275: 10275,
      276: 10276,
      277: 10277,
      278: 10278,
      279: 10279,
      280: 10280,
      281: 10281,
      282: 10282,
      283: 10283,
      284: 10284,
      285: 10285,
      286: 10286,
      287: 10287,
      288: 10288,
      289: 10289,
      290: 10290,
      291: 10291,
      292: 10292,
      293: 10293,
      294: 10294,
      295: 10295,
      296: 10296,
      297: 10297,
      298: 10298,
      299: 10299,
      300: 10300,
      301: 10301,
      302: 10302,
      303: 10303,
      304: 10304,
      305: 10305,
      306: 10306,
      307: 10307,
      308: 10308,
      309: 10309,
      310: 10310,
      311: 10311,
      312: 10312,
      313: 10313,
      314: 10314,
      315: 10315,
      316: 10316,
      317: 10317,
      318: 10318,
      319: 10319,
      320: 10320,
      321: 10321,
      322: 10322,
      323: 10323,
      324: 10324,
      325: 10325,
      326: 10326,
      327: 10327,
      328: 10328,
      329: 10329,
      330: 10330,
      331: 10331,
      332: 10332,
      333: 10333,
      334: 10334,
      335: 10335,
      336: 10336,
      337: 10337,
      338: 10338,
      339: 10339,
      340: 10340,
      341: 10341,
      342: 10342,
      343: 10343,
      344: 10344,
      345: 10345,
      346: 10346,
      347: 10347,
      348: 10348,
      349: 10349,
      350: 10350,
      351: 10351,
      352: 10352,
      353: 10353,
      354: 10354,
      355: 10355,
      356: 10356,
      357: 10357,
      358: 10358,
      359: 10359,
      360: 10360,
      361: 10361,
      362: 10362,
      363: 10363,
      364: 10364,
      365: 10365,
      366: 10366,
      367: 10367,
      368: 10368,
      369: 10369,
      370: 10370,
      371: 10371,
      372: 10372,
      373: 10373,
      374: 10374,
      375: 10375,
      376: 10376,
      377: 10377,
      378: 10378,
      379: 10379,
      380: 10380,
      381: 10381,
      382: 10382,
      383: 10383,
      384: 10384,
      385: 10385,
      386: 10386,
      387: 10387,
      388: 10388,
      389: 10389,
      390: 10390,
      391: 10391,
      392: 10392,
      393: 10393,
      394: 10394,
      395: 10395,
      396: 10396,
      397: 10397,
      398: 10398,
      399: 10399,
      400: 10400,
      401: 10401,
      402: 10402,
      403: 10403,
      404: 10404,
      405: 10405,
      406: 10406,
      407: 10407,
      408: 10408,
      409: 10409,
      410: 10410,
      411: 10411,
      412: 10412,
      413: 10413,
      414: 10414,
      415: 10415,
      416: 10416,
      417: 10417,
      418: 10418,
      419: 10419,
      420: 10420,
      421: 10421,
      422: 10422,
      423: 10423,
      424: 10424,
      425: 10425,
      426: 10426,
      427: 10427,
      428: 10428,
      429: 10429,
      430: 10430,
      431: 10431,
      432: 10432,
      433: 10433,
      434: 10434,
      435: 10435,
      436: 10436,
      437: 10437,
      438: 10438,
      439: 10439,
      440: 10440,
      441: 10441,
      442: 10442,
      443: 10443,
      444: 10444,
      445: 10445,
      446: 10446,
      447: 10447,
      448: 10448,
      449: 10449,
      450: 10450,
      451: 10451,
      452: 10452,
      453: 10453,
      454: 10454,
      455: 10455,
      456: 10456,
      457: 10457,
      458: 10458,
      459: 10459,
      460: 10460,
      461: 10461,
      462: 10462,
      463: 10463,
      464: 10464,
      465: 10465,
      466: 10466,
      467: 10467,
      468: 10468,
      469: 10469,
      470: 10470,
      471: 10471,
      472: 10472,
      473: 10473,
      474: 10474,
      475: 10475,
      476: 10476,
      477: 10477,
      478: 10478,
      479: 10479,
      480: 10480,
      481: 10481,
      482: 10482,
      483: 10483,
      484: 10484,
      485: 10485,
      486: 10486,
      487: 10487,
      488: 10488,
      489: 10489,
      490: 10490,
      491: 10491,
      492: 10492,
      493: 10493,
      494: 10494,
      495: 10495,
      496: 10496,
      497: 10497,
      498: 10498,
      499: 10499,
      500: 10500,
      501: 10501,
      502: 10502,
      503: 10503,
      504: 10504,
      505: 10505,
      506: 10506,
      507: 10507,
      508: 10508,
      509: 10509,
      510: 10510,
      511: 10511,
      512: 10512,
      513: 10513,
      514: 10514,
      515: 10515,
      516: 10516,
      517: 10517,
      518: 10518,
      519: 10519,
      520: 10520
    },
    4: {
      1: 28752,
      2: 28753,
      3: 28754,
      4: 28755,
      5: 28756,
      6: 28757,
      7: 28758,
      8: 28759,
      9: 28760,
      10: 28761,
      11: 28762,
      12: 28763,
      13: 28764,
      14: 28765,
      15: 28766,
      16: 28767,
      17: 28768,
      18: 28769,
      19: 28770,
      20: 28780,
      21: 28781,
      22: 28782,
      23: 28783,
      24: 28784,
      25: 28785,
      26: 28786,
      27: 28787,
      28: 28788,
      29: 28789,
      30: 28790,
      31: 28791,
      32: 28792,
      33: 28793,
      34: 28794,
      35: 28795,
      36: 28796,
      37: 28797,
      38: 28798,
      39: 28799,
      40: 28800,
      41: 28801,
      42: 28803,
      43: 28804,
      44: 28805,
      45: 28806,
      46: 28807,
      47: 28808,
      48: 28809,
      49: 28810,
      50: 28811,
      51: 28812,
      52: 28813,
      53: 28814,
      54: 28815,
      55: 28816,
      56: 28817,
      57: 28818,
      58: 28819,
      59: 28820,
      60: 28821,
      61: 28827,
      62: 28828,
      63: 28829,
      64: 28830,
      65: 28831,
      66: 28832,
      67: 28833,
      68: 28834,
      69: 28835,
      70: 28836,
      71: 28837,
      72: 28838,
      73: 28839,
      74: 28840,
      75: 28841,
      76: 28842,
      77: 28843,
      78: 28844,
      79: 28845,
      80: 28846,
      81: 28847,
      82: 28848,
      83: 28849,
      84: 28850,
      85: 28851,
      86: 28852,
      87: 28853,
      88: 28854,
      89: 28855,
      90: 28856,
      91: 28857,
      92: 28858,
      93: 28859,
      94: 28860,
      95: 28862,
      96: 28863,
      97: 28864,
      98: 28865,
      99: 28866,
      100: 28867,
      101: 28868,
      102: 28869,
      103: 28870,
      104: 28871,
      105: 28872,
      106: 28873,
      107: 28874,
      108: 28875,
      109: 28876,
      110: 28877,
      111: 28878,
      112: 28879,
      113: 28880,
      114: 28881,
      115: 28882,
      116: 28883,
      117: 28884,
      118: 28885,
      119: 28886,
      120: 28887,
      121: 28888,
      122: 28889,
      123: 28890,
      124: 28892,
      125: 28893,
      126: 28894,
      127: 28895,
      128: 28896,
      129: 28897,
      130: 28898,
      131: 28899,
      132: 28900,
      133: 28901,
      134: 28902,
      135: 28903,
      136: 28904,
      137: 28905,
      138: 28906,
      139: 28907,
      140: 28908,
      141: 28909,
      142: 28910,
      143: 28911,
      144: 28912,
      145: 28913,
      146: 28914,
      147: 28915,
      148: 28916,
      149: 28917,
      150: 28918,
      151: 28919,
      152: 28920,
      153: 28922,
      154: 28923,
      155: 28924,
      156: 28925,
      157: 28926,
      158: 28927,
      159: 28928,
      160: 28929,
      161: 28930,
      162: 28931,
      163: 28932,
      164: 28933,
      165: 28934,
      166: 28935,
      167: 28936,
      168: 28937,
      169: 28938,
      170: 28939,
      171: 28943,
      172: 28944,
      173: 28945,
      174: 28946,
      175: 28947,
      176: 28948,
      177: 28949,
      178: 28950,
      179: 28951,
      180: 28952,
      181: 28953,
      182: 28954,
      183: 28955,
      184: 28956,
      185: 28957,
      186: 28958,
      187: 28959,
      188: 28960,
      189: 28961,
      190: 28962,
      191: 28963,
      192: 28964,
      193: 28965,
      194: 28966,
      195: 28967,
      196: 28969,
      197: 28970,
      198: 28971,
      199: 28972,
      200: 28973,
      201: 28974,
      202: 28975,
      203: 28978,
      204: 28979,
      205: 28980,
      206: 28981,
      207: 28982,
      208: 28983,
      209: 28984,
      210: 28985,
      211: 28986,
      212: 28987,
      213: 28988,
      214: 28989,
      215: 28990,
      216: 28991,
      217: 28992,
      218: 28993,
      219: 28994,
      220: 28995,
      221: 28996,
      222: 28997,
      223: 28998,
      224: 28999,
      225: 29000,
      226: 29001,
      227: 29002,
      228: 29003,
      229: 29004,
      230: 29005,
      231: 29006,
      232: 29007,
      233: 29008,
      234: 29009,
      235: 29010,
      236: 29011,
      237: 29012,
      238: 29013,
      239: 29014,
      240: 29015,
      241: 29016,
      242: 29017,
      243: 29018,
      244: 29019,
      245: 29020,
      246: 29021,
      247: 29022,
      248: 29023,
      249: 29024,
      250: 29025,
      251: 29026,
      252: 29028,
      253: 29029,
      254: 29030,
      255: 29031,
      256: 29032,
      257: 29033,
      258: 29034,
      259: 29035,
      260: 29036,
      261: 29037,
      262: 29038,
      263: 29039,
      264: 29040,
      265: 29041,
      266: 29042,
      267: 29043,
      268: 29044,
      269: 29045,
      270: 29046,
      271: 29047,
      272: 29048,
      273: 29049,
      274: 29050,
      275: 29051,
      276: 29052,
      277: 29053,
      278: 29054,
      279: 29055,
      280: 29056,
      281: 29057,
      282: 29058,
      283: 29059,
      284: 29060,
      285: 29061,
      286: 29062,
      287: 29063,
      288: 29064,
      289: 29065,
      290: 29066,
      291: 29067,
      292: 29068,
      293: 29069,
      294: 29070,
      295: 29071,
      296: 29072,
      297: 29073,
      298: 29074,
      299: 29075,
      300: 29076,
      301: 29077,
      302: 29078,
      303: 29079,
      304: 29080,
      305: 29081,
      306: 29082,
      307: 29083,
      308: 29085,
      309: 29086,
      310: 29087,
      311: 29088,
      312: 29089,
      313: 29090,
      314: 29091,
      315: 29092,
      316: 29093,
      317: 29094,
      318: 29095,
      319: 29096,
      320: 29097,
      321: 29098,
      322: 29099,
      323: 29100,
      324: 29101,
      325: 29102,
      326: 29103,
      327: 29104,
      328: 29105,
      329: 29106,
      330: 29107,
      331: 29108,
      332: 29110,
      333: 29111,
      334: 29112,
      335: 29113,
      336: 29114,
      337: 29115,
      338: 29116,
      339: 29117,
      340: 29118,
      341: 29119,
      342: 29120,
      343: 29121,
      344: 29122,
      345: 29123,
      346: 29124,
      347: 29125,
      348: 29126,
      349: 29127,
      350: 29128,
      351: 29129,
      352: 29130,
      353: 29131,
      354: 29132,
      355: 29133,
      356: 29134,
      357: 29135,
      358: 29136,
      359: 29137,
      360: 29138,
      361: 29139,
      362: 29141,
      363: 29142,
      364: 29143,
      365: 29144,
      366: 29145,
      367: 29146,
      368: 29147,
      369: 29148,
      370: 29149,
      371: 29150,
      372: 29151,
      373: 29152,
      374: 29153,
      375: 29154,
      376: 29155,
      377: 29156,
      378: 29157,
      379: 29158,
      380: 29159,
      381: 29160,
      382: 29161,
      383: 29162,
      384: 29163,
      385: 29164,
      386: 29165,
      387: 29166,
      388: 29167,
      389: 29168,
      390: 29169,
      391: 29170,
      392: 29171,
      393: 29172,
      394: 29173,
      395: 29174,
      396: 29175,
      397: 29176,
      398: 29177,
      399: 29179,
      400: 29180,
      401: 29181,
      402: 29182,
      403: 29183,
      404: 29184,
      405: 29185,
      406: 29186,
      407: 29187,
      408: 29188,
      409: 29189,
      410: 29190,
      411: 29191,
      412: 29192,
      413: 29193,
      414: 29194,
      415: 29195,
      416: 29196,
      417: 29197,
      418: 29198,
      419: 29200,
      420: 29201,
      421: 29202,
      422: 29203,
      423: 29204,
      424: 29205,
      425: 29206,
      426: 29207,
      427: 29208,
      428: 29209,
      429: 29210,
      430: 29211,
      431: 29212,
      432: 29213,
      433: 29214,
      434: 29215,
      435: 29216,
      436: 29217,
      437: 29218,
      438: 29219,
      439: 29220,
      440: 29221,
      441: 29222,
      442: 29223,
      443: 29224,
      444: 29225,
      445: 29226,
      446: 29227,
      447: 29228,
      448: 29229,
      449: 29230,
      450: 29231,
      451: 29232,
      452: 29233,
      453: 29234,
      454: 29235,
      455: 29236,
      456: 29237
    }
  }
  return SeatData[floor][seatNo];
}
